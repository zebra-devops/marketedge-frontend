{"version":3,"sources":["/Users/matt/Sites/MarketEdge/platform-wrapper/frontend/src/hooks/useAuth.ts"],"sourcesContent":["'use client'\n\nimport { useState, useEffect, createContext, useContext } from 'react'\nimport { User } from '@/types/auth'\nimport { authService } from '@/services/auth'\n\ninterface EnhancedUser extends User {\n  created_at?: string\n  updated_at?: string\n}\n\ninterface TenantInfo {\n  id: string\n  name: string\n  industry: string\n  subscription_plan: string\n}\n\ninterface AuthState {\n  user: EnhancedUser | null\n  tenant: TenantInfo | null\n  permissions: string[]\n  isLoading: boolean\n  isAuthenticated: boolean\n  isInitialized: boolean\n}\n\ninterface AuthContextType extends AuthState {\n  login: (loginData: { code: string; redirect_uri: string; state?: string }) => Promise<any>\n  logout: (allDevices?: boolean) => Promise<void>\n  refreshUser: () => Promise<void>\n  hasPermission: (permission: string) => boolean\n  hasAnyPermission: (permissions: string[]) => boolean\n  hasRole: (role: string) => boolean\n  checkSession: () => Promise<any>\n  extendSession: () => Promise<any>\n  getTenantContext: () => TenantInfo | null\n  validateTenantAccess: (requiredTenant: string) => boolean\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined)\n\nexport const useAuthContext = (): AuthContextType => {\n  const context = useContext(AuthContext)\n  if (!context) {\n    throw new Error('useAuthContext must be used within an AuthProvider')\n  }\n  return context\n}\n\nexport const useAuth = (): AuthContextType => {\n  const [state, setState] = useState<AuthState>({\n    user: null,\n    tenant: null,\n    permissions: [],\n    isLoading: true,\n    isAuthenticated: false,\n    isInitialized: false\n  })\n\n  useEffect(() => {\n    initializeAuth()\n  }, [])\n\n  const initializeAuth = async () => {\n    try {\n      setState(prev => ({ ...prev, isLoading: true }))\n\n      // Check if user has valid authentication\n      if (authService.isAuthenticated()) {\n        try {\n          // Get current user data from backend\n          const userResponse = await authService.getCurrentUser()\n          const permissions = authService.getUserPermissions()\n          \n          setState({\n            user: userResponse.user,\n            tenant: userResponse.tenant,\n            permissions,\n            isLoading: false,\n            isAuthenticated: true,\n            isInitialized: true\n          })\n        } catch (error) {\n          console.error('Failed to get current user:', error)\n          // Clear invalid tokens\n          await authService.logout()\n          setState({\n            user: null,\n            tenant: null,\n            permissions: [],\n            isLoading: false,\n            isAuthenticated: false,\n            isInitialized: true\n          })\n        }\n      } else {\n        setState({\n          user: null,\n          tenant: null,\n          permissions: [],\n          isLoading: false,\n          isAuthenticated: false,\n          isInitialized: true\n        })\n      }\n    } catch (error) {\n      console.error('Auth initialization failed:', error)\n      setState({\n        user: null,\n        tenant: null,\n        permissions: [],\n        isLoading: false,\n        isAuthenticated: false,\n        isInitialized: true\n      })\n    }\n  }\n\n  const login = async (loginData: { code: string; redirect_uri: string; state?: string }) => {\n    setState(prev => ({ ...prev, isLoading: true }))\n    \n    try {\n      const response = await authService.login(loginData)\n      \n      setState({\n        user: response.user,\n        tenant: response.tenant,\n        permissions: response.permissions,\n        isLoading: false,\n        isAuthenticated: true,\n        isInitialized: true\n      })\n\n      return response\n    } catch (error) {\n      setState(prev => ({\n        ...prev,\n        isLoading: false,\n        user: null,\n        tenant: null,\n        permissions: [],\n        isAuthenticated: false\n      }))\n      throw error\n    }\n  }\n\n  const logout = async (allDevices: boolean = false) => {\n    setState(prev => ({ ...prev, isLoading: true }))\n    \n    try {\n      await authService.logout(allDevices)\n    } catch (error) {\n      console.warn('Logout error:', error)\n    } finally {\n      setState({\n        user: null,\n        tenant: null,\n        permissions: [],\n        isLoading: false,\n        isAuthenticated: false,\n        isInitialized: true\n      })\n    }\n  }\n\n  const refreshUser = async () => {\n    try {\n      const userResponse = await authService.getCurrentUser()\n      const permissions = authService.getUserPermissions()\n      \n      setState(prev => ({\n        ...prev,\n        user: userResponse.user,\n        tenant: userResponse.tenant,\n        permissions\n      }))\n    } catch (error) {\n      console.error('Failed to refresh user data:', error)\n      throw error\n    }\n  }\n\n  const hasPermission = (permission: string): boolean => {\n    return authService.hasPermission(permission)\n  }\n\n  const hasAnyPermission = (permissions: string[]): boolean => {\n    return authService.hasAnyPermission(permissions)\n  }\n\n  const hasRole = (role: string): boolean => {\n    return authService.getUserRole() === role\n  }\n\n  const checkSession = async () => {\n    try {\n      return await authService.checkSession()\n    } catch (error) {\n      console.error('Session check failed:', error)\n      throw error\n    }\n  }\n\n  const extendSession = async () => {\n    try {\n      return await authService.extendSession()\n    } catch (error) {\n      console.error('Session extension failed:', error)\n      throw error\n    }\n  }\n\n  const getTenantContext = (): TenantInfo | null => {\n    return state.tenant\n  }\n\n  const validateTenantAccess = (requiredTenant: string): boolean => {\n    if (!state.tenant || !state.isAuthenticated) {\n      return false\n    }\n    return state.tenant.id === requiredTenant\n  }\n\n  return {\n    ...state,\n    login,\n    logout,\n    refreshUser,\n    hasPermission,\n    hasAnyPermission,\n    hasRole,\n    checkSession,\n    extendSession,\n    getTenantContext,\n    validateTenantAccess\n  }\n}\n\nexport { AuthContext }"],"names":["AuthContext","useAuth","useAuthContext","createContext","undefined","context","useContext","Error","state","setState","useState","user","tenant","permissions","isLoading","isAuthenticated","isInitialized","useEffect","initializeAuth","prev","authService","userResponse","getCurrentUser","getUserPermissions","error","console","logout","login","loginData","response","allDevices","warn","refreshUser","hasPermission","permission","hasAnyPermission","hasRole","role","getUserRole","checkSession","extendSession","getTenantContext","validateTenantAccess","requiredTenant","id"],"mappings":"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"}