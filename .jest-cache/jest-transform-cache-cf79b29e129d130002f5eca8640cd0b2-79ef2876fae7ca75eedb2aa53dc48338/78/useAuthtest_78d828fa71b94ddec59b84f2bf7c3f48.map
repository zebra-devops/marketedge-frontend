{"version":3,"sources":["/Users/matt/Sites/MarketEdge/platform-wrapper/frontend/src/hooks/__tests__/useAuth.test.tsx"],"sourcesContent":["import React from 'react'\nimport { renderHook, act, waitFor } from '@testing-library/react'\nimport { useAuth, useAuthContext, AuthContext } from '../useAuth'\nimport { authService } from '@/services/auth'\n\n// Mock auth service\njest.mock('@/services/auth', () => ({\n  authService: {\n    isAuthenticated: jest.fn(),\n    getCurrentUser: jest.fn(),\n    login: jest.fn(),\n    logout: jest.fn(),\n  },\n}))\n\nconst mockAuthService = authService as jest.Mocked<typeof authService>\n\ndescribe('useAuth Hook', () => {\n  beforeEach(() => {\n    jest.clearAllMocks()\n    // Reset console.error mock\n    jest.spyOn(console, 'error').mockImplementation(() => {})\n  })\n\n  afterEach(() => {\n    jest.restoreAllMocks()\n  })\n\n  it('initializes with loading state', () => {\n    mockAuthService.isAuthenticated.mockReturnValue(false)\n    \n    const { result } = renderHook(() => useAuth())\n    \n    expect(result.current.user).toBeNull()\n    expect(result.current.isLoading).toBe(true)\n    expect(result.current.isAuthenticated).toBe(false)\n  })\n\n  it('loads authenticated user on initialization', async () => {\n    const mockUser = {\n      id: '1',\n      email: 'test@example.com',\n      name: 'Test User',\n      role: 'user',\n      organisation_id: 'org-1',\n      is_active: true,\n      created_at: '2023-01-01T00:00:00Z',\n      updated_at: '2023-01-01T00:00:00Z',\n    }\n\n    mockAuthService.isAuthenticated.mockReturnValue(true)\n    mockAuthService.getCurrentUser.mockResolvedValue(mockUser)\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.isLoading).toBe(false)\n    })\n    \n    expect(result.current.user).toEqual(mockUser)\n    expect(result.current.isAuthenticated).toBe(true)\n    expect(mockAuthService.getCurrentUser).toHaveBeenCalledTimes(1)\n  })\n\n  it('handles initialization failure', async () => {\n    mockAuthService.isAuthenticated.mockReturnValue(true)\n    mockAuthService.getCurrentUser.mockRejectedValue(new Error('API Error'))\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.isLoading).toBe(false)\n    })\n    \n    expect(result.current.user).toBeNull()\n    expect(result.current.isAuthenticated).toBe(false)\n    expect(mockAuthService.logout).toHaveBeenCalledTimes(1)\n    expect(console.error).toHaveBeenCalledWith('Auth initialization failed:', expect.any(Error))\n  })\n\n  it('handles login successfully', async () => {\n    const mockUser = {\n      id: '1',\n      email: 'test@example.com',\n      name: 'Test User',\n      role: 'user',\n      organisation_id: 'org-1',\n      is_active: true,\n      created_at: '2023-01-01T00:00:00Z',\n      updated_at: '2023-01-01T00:00:00Z',\n    }\n\n    mockAuthService.isAuthenticated.mockReturnValue(false)\n    mockAuthService.login.mockResolvedValue({ user: mockUser })\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.isLoading).toBe(false)\n    })\n    \n    await act(async () => {\n      await result.current.login('auth-code', 'http://localhost:3000/callback')\n    })\n    \n    expect(result.current.user).toEqual(mockUser)\n    expect(result.current.isAuthenticated).toBe(true)\n    expect(mockAuthService.login).toHaveBeenCalledWith({\n      code: 'auth-code',\n      redirect_uri: 'http://localhost:3000/callback'\n    })\n  })\n\n  it('handles login failure', async () => {\n    const loginError = new Error('Login failed')\n    mockAuthService.isAuthenticated.mockReturnValue(false)\n    mockAuthService.login.mockRejectedValue(loginError)\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.isLoading).toBe(false)\n    })\n    \n    await expect(\n      act(async () => {\n        await result.current.login('invalid-code', 'http://localhost:3000/callback')\n      })\n    ).rejects.toThrow('Login failed')\n    \n    expect(result.current.user).toBeNull()\n    expect(result.current.isAuthenticated).toBe(false)\n    expect(console.error).toHaveBeenCalledWith('Login failed:', loginError)\n  })\n\n  it('handles logout', async () => {\n    const mockUser = {\n      id: '1',\n      email: 'test@example.com',\n      name: 'Test User',\n      role: 'user',\n      organisation_id: 'org-1',\n      is_active: true,\n      created_at: '2023-01-01T00:00:00Z',\n      updated_at: '2023-01-01T00:00:00Z',\n    }\n\n    mockAuthService.isAuthenticated.mockReturnValue(true)\n    mockAuthService.getCurrentUser.mockResolvedValue(mockUser)\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.user).toEqual(mockUser)\n    })\n    \n    act(() => {\n      result.current.logout()\n    })\n    \n    expect(result.current.user).toBeNull()\n    expect(result.current.isAuthenticated).toBe(false)\n    expect(mockAuthService.logout).toHaveBeenCalledTimes(1)\n  })\n\n  it('handles user refresh successfully', async () => {\n    const initialUser = {\n      id: '1',\n      email: 'test@example.com',\n      name: 'Test User',\n      role: 'user',\n      organisation_id: 'org-1',\n      is_active: true,\n      created_at: '2023-01-01T00:00:00Z',\n      updated_at: '2023-01-01T00:00:00Z',\n    }\n\n    const updatedUser = {\n      ...initialUser,\n      name: 'Updated User',\n      updated_at: '2023-01-02T00:00:00Z',\n    }\n\n    mockAuthService.isAuthenticated.mockReturnValue(true)\n    mockAuthService.getCurrentUser\n      .mockResolvedValueOnce(initialUser)\n      .mockResolvedValueOnce(updatedUser)\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.user).toEqual(initialUser)\n    })\n    \n    await act(async () => {\n      await result.current.refreshUser()\n    })\n    \n    expect(result.current.user).toEqual(updatedUser)\n    expect(mockAuthService.getCurrentUser).toHaveBeenCalledTimes(2)\n  })\n\n  it('handles user refresh failure', async () => {\n    const mockUser = {\n      id: '1',\n      email: 'test@example.com',\n      name: 'Test User',\n      role: 'user',\n      organisation_id: 'org-1',\n      is_active: true,\n      created_at: '2023-01-01T00:00:00Z',\n      updated_at: '2023-01-01T00:00:00Z',\n    }\n\n    mockAuthService.isAuthenticated.mockReturnValue(true)\n    mockAuthService.getCurrentUser\n      .mockResolvedValueOnce(mockUser)\n      .mockRejectedValueOnce(new Error('Refresh failed'))\n    \n    const { result } = renderHook(() => useAuth())\n    \n    await waitFor(() => {\n      expect(result.current.user).toEqual(mockUser)\n    })\n    \n    await act(async () => {\n      await result.current.refreshUser()\n    })\n    \n    expect(result.current.user).toBeNull()\n    expect(result.current.isAuthenticated).toBe(false)\n    expect(mockAuthService.logout).toHaveBeenCalledTimes(1)\n    expect(console.error).toHaveBeenCalledWith('User refresh failed:', expect.any(Error))\n  })\n})\n\ndescribe('useAuthContext Hook', () => {\n  const mockAuthContextValue = {\n    user: null,\n    isAuthenticated: false,\n    isLoading: false,\n    login: jest.fn(),\n    logout: jest.fn(),\n    refreshUser: jest.fn(),\n  }\n\n  it('returns context value when used within provider', () => {\n    const wrapper = ({ children }: { children: React.ReactNode }) => (\n      <AuthContext.Provider value={mockAuthContextValue}>\n        {children}\n      </AuthContext.Provider>\n    )\n\n    const { result } = renderHook(() => useAuthContext(), { wrapper })\n    \n    expect(result.current).toBe(mockAuthContextValue)\n  })\n\n  it('throws error when used outside provider', () => {\n    const { result } = renderHook(() => useAuthContext())\n    \n    expect(result.error).toEqual(\n      new Error('useAuthContext must be used within an AuthProvider')\n    )\n  })\n\n  it('provides all required context properties', () => {\n    const wrapper = ({ children }: { children: React.ReactNode }) => (\n      <AuthContext.Provider value={mockAuthContextValue}>\n        {children}\n      </AuthContext.Provider>\n    )\n\n    const { result } = renderHook(() => useAuthContext(), { wrapper })\n    \n    expect(result.current).toHaveProperty('user')\n    expect(result.current).toHaveProperty('isAuthenticated')\n    expect(result.current).toHaveProperty('isLoading')\n    expect(result.current).toHaveProperty('login')\n    expect(result.current).toHaveProperty('logout')\n    expect(result.current).toHaveProperty('refreshUser')\n  })\n})"],"names":["jest","mock","authService","isAuthenticated","fn","getCurrentUser","login","logout","mockAuthService","describe","beforeEach","clearAllMocks","spyOn","console","mockImplementation","afterEach","restoreAllMocks","it","mockReturnValue","result","renderHook","useAuth","expect","current","user","toBeNull","isLoading","toBe","mockUser","id","email","name","role","organisation_id","is_active","created_at","updated_at","mockResolvedValue","waitFor","toEqual","toHaveBeenCalledTimes","mockRejectedValue","Error","error","toHaveBeenCalledWith","any","act","code","redirect_uri","loginError","rejects","toThrow","initialUser","updatedUser","mockResolvedValueOnce","refreshUser","mockRejectedValueOnce","mockAuthContextValue","wrapper","children","AuthContext","Provider","value","useAuthContext","toHaveProperty"],"mappings":"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"}